<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÖestVèl Navigator - AS-20260203-0834</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <style>
        :root { --g-blue: #4285F4; --g-green: #34a853; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Roboto', sans-serif; overflow: hidden; }

        /* Navigation Banner - Only shows during active nav */
        #nav-banner {
            position: absolute; top: 0; left: 0; right: 0;
            background: var(--g-green); color: white; padding: 20px;
            z-index: 2000; display: none; align-items: center; gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Floating Search Card */
        #search-card {
            position: absolute; top: 15px; left: 10px; right: 10px;
            background: white; border-radius: 8px; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 500px; margin: auto;
        }
        #search-input { width: 100%; border: none; padding: 15px; font-size: 16px; border-radius: 8px; outline: none; }

        /* Route Selection Panel - Shows after "Find Route" */
        #route-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; padding: 20px; z-index: 1500;
            display: none; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1); text-align: center;
        }

        #map { height: 100vh; width: 100%; z-index: 1; }

        .btn-go {
            background: var(--g-blue); color: white; border: none;
            padding: 15px 40px; border-radius: 30px; font-size: 1.2rem;
            font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%;
        }

        #results { background: white; max-height: 250px; overflow-y: auto; }
        .res-item { padding: 15px; border-top: 1px solid #eee; cursor: pointer; }

        .speedo {
            position: absolute; bottom: 30px; left: 20px;
            background: white; border-radius: 50%; width: 60px; height: 60px;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid var(--g-blue);
        }
    </style>
</head>
<body>

    <div id="nav-banner">
        <div style="font-size: 2rem;">↑</div>
        <div>
            <span id="inst-text" style="font-weight: bold; font-size: 1.2rem;">Follow Route</span><br>
            <span id="inst-dist" style="font-size: 0.9rem;">GPS Syncing...</span>
        </div>
    </div>

    <div id="search-card">
        <input type="text" id="search-input" placeholder="Search ÖestVèl..." oninput="getPlaces(this.value)">
        <div id="results"></div>
    </div>

    <div id="route-panel">
        <h3 id="dest-name" style="margin: 0 0 5px 0;">Destination</h3>
        <p id="route-stats" style="color: #666; margin-bottom: 15px;">-- min • -- km</p>
        <button class="btn-go" onclick="startNavigation()">START NAVIGATION</button>
    </div>

    <div id="map"></div>

    <div class="speedo">
        <b id="speed-val">0</b><br><small>MPH</small>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
        let map, userMarker, routingControl, routeData;
        let uLat, uLon;
        let isNavActive = false;

        map = L.map('map', { zoomControl: false }).setView([51.45, -2.58], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

        userMarker = L.circleMarker([0,0], { radius: 8, color: '#fff', fillColor: '#4285F4', fillOpacity: 1, weight: 3 }).addTo(map);

        navigator.geolocation.watchPosition(pos => {
            uLat = pos.coords.latitude; uLon = pos.coords.longitude;
            userMarker.setLatLng([uLat, uLon]);
            document.getElementById('speed-val').innerText = Math.round((pos.coords.speed || 0) * 2.23694);

            if (isNavActive) {
                map.setZoom(18); map.panTo([uLat, uLon]);
                updateInstructions();
            }
        }, null, { enableHighAccuracy: true });

        async function getPlaces(q) {
            const resDiv = document.getElementById('results');
            if (q.length < 3) { resDiv.innerHTML = ""; return; }
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=4`);
            const data = await res.json();
            resDiv.innerHTML = data.map(i => `
                <div class="res-item" onclick="findRoute(${i.lat}, ${i.lon}, '${i.display_name.split(',')[0]}')">
                    ${i.display_name.split(',')[0]}
                </div>
            `).join('');
        }

        function findRoute(dLat, dLon, dName) {
            document.getElementById('results').innerHTML = "";
            document.getElementById('dest-name').innerText = dName;
            document.getElementById('route-panel').style.display = "block";

            if (routingControl) map.removeControl(routingControl);

            routingControl = L.Routing.control({
                waypoints: [L.latLng(uLat, uLon), L.latLng(dLat, dLon)],
                createMarker: () => null,
                lineOptions: { styles: [{ color: '#4285F4', weight: 6 }] }
            }).on('routesfound', e => {
                routeData = e.routes[0];
                const mins = Math.round(routeData.summary.totalTime / 60);
                const km = (routeData.summary.totalDistance / 1000).toFixed(1);
                document.getElementById('route-stats').innerText = `${mins} min (${km} km)`;
            }).addTo(map);
        }

        function startNavigation() {
            isNavActive = true;
            document.getElementById('route-panel').style.display = "none";
            document.getElementById('search-card').style.display = "none";
            document.getElementById('nav-banner').style.display = "flex";
            map.flyTo([uLat, uLon], 18);
        }

        function updateInstructions() {
            if (routeData && routeData.instructions) {
                const step = routeData.instructions[0];
                document.getElementById('inst-text').innerText = step.text;
                document.getElementById('inst-dist').innerText = `In ${Math.round(step.distance)} meters`;
            }
        }
    </script>
</body>
</html>
